{% extends "base.html" %}
{% set active_page = "upload" %}

{% block title %}Upload Images{% endblock %}

{% block content %}
<div class="mb-8">
    <h1 class="text-2xl font-bold">Upload Images</h1>
    <p class="text-gray-500 mt-1">Add images to your content library ‚Äî select multiple at once</p>
</div>

<div class="max-w-2xl">
    <form method="POST" action="/dashboard/upload" enctype="multipart/form-data" class="space-y-6" id="upload-form">

        <!-- Image files (multiple) -->
        <div>
            <label class="block text-sm font-medium text-gray-300 mb-2">Image Files</label>
            <div id="drop-zone"
                 class="border-2 border-dashed border-white/10 rounded-xl p-10 text-center hover:border-accent-400/40 transition cursor-pointer">
                <input type="file" name="image_files" accept="image/*" required id="file-input" class="hidden" multiple>
                <div id="drop-text">
                    <p class="text-gray-400 text-lg mb-1">üì∑ Drop images here or click to browse</p>
                    <p class="text-gray-600 text-sm">Select multiple files ‚Äî JPG, PNG, WebP</p>
                </div>
                <div id="file-preview" class="hidden">
                    <div id="preview-grid" class="grid grid-cols-4 gap-2 mb-3"></div>
                    <p id="file-count" class="text-accent-400 font-medium text-sm"></p>
                </div>
            </div>
        </div>

        <!-- Content Type (critical) -->
        <div>
            <label class="block text-sm font-medium text-gray-300 mb-2">‚ö†Ô∏è Content Type</label>
            <div class="grid grid-cols-2 gap-4">
                <label class="card rounded-xl p-4 cursor-pointer has-[:checked]:border-green-500/50 has-[:checked]:bg-green-500/5 transition">
                    <input type="radio" name="content_type" value="instagram" class="sr-only" required>
                    <div class="text-center">
                        <span class="text-2xl">üì∏</span>
                        <p class="font-medium text-sm mt-2">Instagram (SFW)</p>
                        <p class="text-gray-500 text-xs mt-1">Safe for public posting</p>
                    </div>
                </label>
                <label class="card rounded-xl p-4 cursor-pointer has-[:checked]:border-red-500/50 has-[:checked]:bg-red-500/5 transition">
                    <input type="radio" name="content_type" value="private" class="sr-only" required>
                    <div class="text-center">
                        <span class="text-2xl">üîí</span>
                        <p class="font-medium text-sm mt-2">Private (NSFW)</p>
                        <p class="text-gray-500 text-xs mt-1">Telegram only ‚Äî NEVER public</p>
                    </div>
                </label>
            </div>
        </div>

        <!-- Category (only shown for Private uploads) -->
        <div id="category-section">
            <label class="block text-sm font-medium text-gray-300 mb-2">Category</label>
            <select name="category_id" id="category-select"
                    class="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-accent-400/50 transition">
                {% for cat in categories %}
                <option value="{{ cat.id }}" data-name="{{ cat.name }}">{{ cat.emoji or 'üìÅ' }} {{ cat.name }}</option>
                {% endfor %}
            </select>
            <p id="ig-cat-note" class="hidden text-green-400 text-xs mt-2">üì∏ Instagram images are automatically categorized.</p>
        </div>

        <div class="grid grid-cols-2 gap-6">
            <!-- Price -->
            <div>
                <label class="block text-sm font-medium text-gray-300 mb-2">Price per image ($)</label>
                <input type="number" name="price" value="5" step="1" min="0" required
                       class="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-accent-400/50 transition">
            </div>

            <!-- Tier -->
            <div>
                <label class="block text-sm font-medium text-gray-300 mb-2">Tier</label>
                <select name="tier"
                        class="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-accent-400/50 transition">
                    <option value="free">Free</option>
                    <option value="basic" selected>Basic</option>
                    <option value="premium">Premium</option>
                    <option value="vip">VIP</option>
                </select>
            </div>
        </div>

        <!-- Explicit content toggle -->
        <div id="explicit-section">
            <label class="flex items-center gap-3 cursor-pointer card rounded-xl p-4">
                <input type="checkbox" name="is_explicit" value="true"
                       class="w-5 h-5 rounded bg-white/5 border-white/20 text-red-500 focus:ring-red-500/30">
                <div>
                    <p class="font-medium text-sm text-red-400">üîû Nude / Explicit Content</p>
                    <p class="text-gray-500 text-xs">Blocks free unlocks ‚Äî users must pay to access</p>
                </div>
            </label>
        </div>

        <p class="text-gray-600 text-xs">Titles are auto-generated from filenames. You can edit them later in the gallery.</p>

        <!-- Submit -->
        <button type="submit" id="upload-btn"
                class="w-full bg-accent-400 hover:bg-accent-500 text-white font-semibold py-3.5 rounded-lg transition text-lg">
            üì§ Upload Images
        </button>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
    const dropZone = document.getElementById('drop-zone');
    const fileInput = document.getElementById('file-input');
    const dropText = document.getElementById('drop-text');
    const filePreview = document.getElementById('file-preview');
    const previewGrid = document.getElementById('preview-grid');
    const fileCount = document.getElementById('file-count');
    const uploadBtn = document.getElementById('upload-btn');
    const uploadForm = document.getElementById('upload-form');

    dropZone.addEventListener('click', () => fileInput.click());

    dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('border-accent-400/60');
    });

    dropZone.addEventListener('dragleave', () => {
        dropZone.classList.remove('border-accent-400/60');
    });

    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('border-accent-400/60');
        if (e.dataTransfer.files.length) {
            fileInput.files = e.dataTransfer.files;
            showPreviews(e.dataTransfer.files);
        }
    });

    fileInput.addEventListener('change', () => {
        if (fileInput.files.length) showPreviews(fileInput.files);
    });

    function showPreviews(files) {
        previewGrid.innerHTML = '';
        const count = files.length;
        const show = Math.min(count, 8);

        for (let i = 0; i < show; i++) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = document.createElement('img');
                img.src = e.target.result;
                img.className = 'w-full aspect-square object-cover rounded-lg';
                previewGrid.appendChild(img);
            };
            reader.readAsDataURL(files[i]);
        }

        fileCount.textContent = count === 1
            ? `1 image selected`
            : `${count} images selected`;
        dropText.classList.add('hidden');
        filePreview.classList.remove('hidden');

        uploadBtn.textContent = count === 1
            ? 'üì§ Upload Image'
            : `üì§ Upload ${count} Images`;
    }

    // Auto-switch category based on content type
    const catSection = document.getElementById('category-section');
    const catSelect = document.getElementById('category-select');
    const igNote = document.getElementById('ig-cat-note');
    const contentRadios = document.querySelectorAll('input[name="content_type"]');

    contentRadios.forEach(radio => {
        radio.addEventListener('change', () => {
            const opts = catSelect.options;
            if (radio.value === 'instagram') {
                // Hide category picker, show note
                catSelect.disabled = true;
                catSelect.style.opacity = '0.4';
                igNote.classList.remove('hidden');
                // Auto-select Instagram Posts
                for (let i = 0; i < opts.length; i++) {
                    if (opts[i].dataset.name === 'Instagram Posts') {
                        catSelect.selectedIndex = i;
                        break;
                    }
                }
            } else {
                // Show category picker, hide IG options
                catSelect.disabled = false;
                catSelect.style.opacity = '1';
                igNote.classList.add('hidden');
                // Select first non-Instagram category
                for (let i = 0; i < opts.length; i++) {
                    if (opts[i].dataset.name !== 'Instagram Posts') {
                        catSelect.selectedIndex = i;
                        break;
                    }
                }
            }
        });
    });

    uploadForm.addEventListener('submit', () => {
        catSelect.disabled = false; // re-enable so value is submitted
        uploadBtn.disabled = true;
        uploadBtn.textContent = '‚è≥ Uploading...';
    });
</script>
{% endblock %}
